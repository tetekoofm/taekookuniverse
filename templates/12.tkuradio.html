{% extends "00.base.html" %}
{% block title %}TKURadio{% endblock %}

{% block content %}
<div class="main-content">
    <div class="tkuradio-page">
        <div class="hero">
            <h1 class="heading">TKU Radio</h1>
            <p class="caption">Click Play to listen. Login will be requested automatically.</p>
        </div>

        <div class="playlist-buttons global-buttons">
            <button id="global-play">Play All</button>
            <button id="global-stop">Stop All</button>
        </div>

        <div class="player-status" id="player-status">Stopped</div>

        <div class="playlist-grid">
            {% for playlist in playlists %}
            <div class="playlist-card" data-id="{{ playlist.spotify_playlist_id }}">
                <img src="{{ playlist.image or 'https://via.placeholder.com/300x300' }}" alt="{{ playlist.playlist_name }}">
                <h3>{{ playlist.playlist_name }}</h3>
                <p>{{ playlist.description }}</p>
                <div class="playlist-buttons">
                    <button class="play-station">Play</button>
                    <button class="stop-station">Stop</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
    const playlists = Array.from(document.querySelectorAll('.playlist-card'));
    let player, deviceId, spotifyToken = "{{ access_token }}";
    let queue = [];
    let currentIndex = 0;
    let globalPlaying = false;
    
    // Initialize Spotify Player
    function initSpotifyPlayer(token, callback) {
        player = new Spotify.Player({
            name: 'TKU Radio Web Player',
            getOAuthToken: cb => cb(token),
            volume: 0.5
        });
    
        player.addListener('ready', ({ device_id }) => {
            deviceId = device_id;
            console.log("Device ready", device_id);
            if (callback) callback();
        });
    
        player.addListener('player_state_changed', state => {
            console.log(state);
            if (state && state.paused && globalPlaying) {
                // Play next when playlist finishes
                currentIndex++;
                if (currentIndex < queue.length) {
                    playPlaylist(queue[currentIndex]);
                } else {
                    globalPlaying = false;
                    document.getElementById('player-status').innerText = "Stopped";
                }
            }
        });
    
        player.connect();
    }
    
    // Play a single playlist
    function playPlaylist(card) {
        if (!spotifyToken) {
            window.location.href = "{{ url_for('login') }}"; // ensures correct path
            return;
        }

        if (!player) {
            initSpotifyPlayer(spotifyToken, () => playPlaylist(card));
            return;
        }

        // Make sure deviceId is ready
        if (!deviceId) {
            console.log("Waiting for device...");
            setTimeout(() => playPlaylist(card), 500);
            return;
        }

        const playlistId = card.dataset.id;
        const name = card.querySelector('h3').innerText;
        document.getElementById('player-status').innerText = `Playing: ${name}`;

        fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
            method: 'PUT',
            body: JSON.stringify({ context_uri: `spotify:playlist:${playlistId}` }),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${spotifyToken}`
            },
        }).then(res => {
            if (!res.ok) console.error('Spotify play error', res);
        });
    }
    
    // Stop playback
    function stopPlayback() {
        if (!deviceId) return;
        fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, {
            method: 'PUT',
            headers: {'Authorization': `Bearer ${spotifyToken}`}
        });
        document.getElementById('player-status').innerText = 'Stopped';
        globalPlaying = false;
    }
    
    // Prepare random queue
    function prepareQueue() {
        queue = [...playlists];
        for (let i = queue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [queue[i], queue[j]] = [queue[j], queue[i]];
        }
    }
    
    // Global Play All button
    document.getElementById('global-play').addEventListener('click', () => {
        if (!spotifyToken) {
            window.location.href = "{{ url_for('login') }}"; 
            return;
        }
        if (!globalPlaying) {
            prepareQueue();
            currentIndex = 0;
            globalPlaying = true;
            playPlaylist(queue[currentIndex]);
        }
    });
    
    document.getElementById('global-stop').addEventListener('click', () => {
        stopPlayback();
    });
    
    // Individual card play/stop
    playlists.forEach(card => {
        const name = card.querySelector('h3').innerText;
        card.querySelector('.play-station').addEventListener('click', () => {
            globalPlaying = false;
            playPlaylist(card);
        });
        card.querySelector('.stop-station').addEventListener('click', () => {
            stopPlayback();
        });
    });
    </script>
    
{% endblock %}
