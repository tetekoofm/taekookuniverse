<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Santa's Delivery Dash</title>
<style>
  body {
    margin: 0;
    background: #000;
    font-family: sans-serif;
    overflow: hidden;
  }
  #scoreBoard {
    text-align: center;
    font-size: 24px;
    color: #fff;
    margin-top: 10px;
  }
  #timer {
    color: #fff;
    text-align: center;
    font-size: 20px;
    margin-top: 5px;
  }
  #stopBtn {
    display: block;
    margin: 10px auto;
    background: #e63946;
    color: #fff;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  #gameArea {
    position: relative;
    width: 1200px;
    height: 1000px;
    margin: 20px auto;
    background: #000;
    border: 2px solid #fff;
    overflow: hidden;
  }
  canvas {
    position: absolute;
    pointer-events: none;
  }

  /* ===== Leaderboard ===== */
  .leaderboard-section {
    width: 100%;
    max-width: 500px;
    margin-top: 40px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    text-align: center;
    z-index: 2;
  }
  .leaderboard-section h2 {
    font-family: 'Orbitron', sans-serif;
    color: #a855f7;
    font-size: 2rem;
    margin-bottom: 15px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  #leaderboard {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #leaderboard li {
    background: rgba(255,255,255,0.95);
    padding: 10px 15px;
    margin: 8px 0;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.3s, box-shadow 0.3s;
  }
  #leaderboard li:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  #leaderboard li:nth-child(1) { background: #ffe082; border: 2px solid gold; }
  #leaderboard li:nth-child(2) { background: #e0e0e0; border: 2px solid silver; }
  #leaderboard li:nth-child(3) { background: #ffd7b5; border: 2px solid #cd7f32; }

  /* ===== Popup ===== */
  #score-popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;  
    justify-content: center;
    align-items: center;
    z-index: 9999;
    pointer-events: auto;
  }
  #score-popup.active {
    display: flex;  
    pointer-events: auto;
  }
  #score-popup .popup-content {
    pointer-events: auto;
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 25px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    animation: popupFade 0.5s ease;
    z-index: 10000;
  }
  @keyframes popupFade {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  #score-popup h2 {
    font-family: 'Orbitron', sans-serif;
    color: #a855f7;
    font-size: 2rem;
    margin-bottom: 15px;
  }
  #score-popup input {
    padding: 10px 15px;
    width: 80%;
    margin-top: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #d1b3ff;
    outline: none;
  }
  #score-popup button {
    margin: 10px 5px;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #6a11cb, #b983ff);
    color: #fff;
    cursor: pointer;
  }
  #score-popup button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(106,17,203,0.4);
  }
  #username-input {
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    margin: 10px;
    font-size: 16px;
  }

  /* Responsive: 1024px (tablet) */
  @media (max-width: 1024px) {
    #scoreBoard { font-size: 22px; }
    #timer { font-size: 18px; }
    #stopBtn { font-size: 18px; padding: 10px 16px; }
    #gameArea { max-width: 768px; height: 85vh; }
    #score-popup .popup-content { padding: 18px; max-width: 350px; }
    #score-popup input { font-size: 0.95rem; padding: 10px 12px; }
    #score-popup button { font-size: 0.95rem; padding: 8px 16px; }
    .leaderboard-section { padding: 12px; }
    .leaderboard-section h2 { font-size: 1.3rem; }
  }

  /* Responsive: 768px */
  @media (max-width: 768px) {
    #scoreBoard { font-size: 20px; }
    #timer { font-size: 16px; }
    #stopBtn { font-size: 16px; padding: 8px 14px; }
    #gameArea { max-width: 95%; height: 80vh; border-width: 1px; margin: 10px auto; }
    #score-popup .popup-content { padding: 15px; max-width: 300px; }
    #score-popup input { font-size: 0.9rem; padding: 8px 10px; }
    #score-popup button { font-size: 0.9rem; padding: 6px 14px; }
    .leaderboard-section { padding: 10px; }
    .leaderboard-section h2 { font-size: 1.1rem; }
  }
</style>
</head>
<body>
<div id="game-container">
  <div id="scoreBoard">Score: 0</div>
  <div id="timer">Time: 30s</div>
  <button id="stopBtn">‚èπ Stop</button>
  <div id="gameArea"></div>

  <!-- Score Popup -->
  <div id="score-popup">
    <div class="popup-content">
      <h2>üéÖ Game Over!</h2>
      <p>Your final score: <span id="final-score">0</span></p>

      <input type="text" id="username-input" placeholder="Enter name (optional)">
      <button class="username-btn" onclick="submitScore()">Submit</button>
      <button class="username-btn" onclick="skipUsername()">Skip</button>

      <div id="post-game-menu" style="display:none;">
        <h3>üèÜ Top Players</h3>
        <ul id="leaderboard"></ul>

        <div class="menu-buttons" style="margin-top: 15px;">
          <button onclick="goHome()">üè† Home</button>
          <button onclick="goGames()">üéÆ Games</button>
          <button onclick="playAgain()">üîÑ Play Again</button>
        </div>
      </div>
    </div>
  </div>

  <section class="leaderboard-section" id="leaderboard-section" style="display:none;">
    <h2>üèÜ Top Players</h2>
    <ul id="leaderboard"></ul>
  </section>

  <div id="confetti"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const gameArea = document.getElementById('gameArea');

function getGameDimensions() {
  return {
    width: gameArea.offsetWidth,
    height: gameArea.offsetHeight
  };
}

let santaSize, objectSize;
let santaX;
let score = 0;
let speed = 2;
let gameRunning = true;
let timer = 30;
let objects = [];

// Images
const santaImgSrc = "{{ url_for('static', filename='images/games/christmas/santa.png') }}";
const giftImages = [
  "{{ url_for('static', filename='images/games/christmas/tata.png') }}",
  "{{ url_for('static', filename='images/games/christmas/cooky.png') }}",
  "{{ url_for('static', filename='images/games/christmas/green_gift.png') }}",
  "{{ url_for('static', filename='images/games/christmas/purple_gift.png') }}"
];
const obstacleImages = [
  "{{ url_for('static', filename='images/games/christmas/snowflake.png') }}",
  "{{ url_for('static', filename='images/games/christmas/snowman.png') }}"
];
const powerupImage = "{{ url_for('static', filename='images/games/christmas/star.png') }}";

// ----- Set initial sizes based on screen -----
function setInitialSizes() {
  const width = window.innerWidth;
  if(width <= 768) { santaSize=80; objectSize=35; }
  else if(width <= 1024) { santaSize=120; objectSize=50; }
  else { santaSize=150; objectSize=70; }

  // Initialize Santa X based on current game width
  const { width: gameWidth } = getGameDimensions();
  santaX = (gameWidth - santaSize)/2;
}
setInitialSizes();

// ----- Santa -----
const santaCanvas = document.createElement('canvas');
santaCanvas.width = santaSize;
santaCanvas.height = santaSize;
santaCanvas.style.position = 'absolute';
santaCanvas.style.bottom = '10px';
santaCanvas.style.left = santaX + 'px';
gameArea.appendChild(santaCanvas);
const santaCtx = santaCanvas.getContext('2d');
const santaImg = new Image();
santaImg.src = santaImgSrc;
santaImg.onload = () => santaCtx.drawImage(santaImg,0,0,santaSize,santaSize);

// ----- Create objects -----
function createObject(type) {
  const { width: gameWidth } = getGameDimensions(); // always latest
  const obj = {
    type: type,
    width: objectSize,
    height: objectSize,
    x: Math.random() * (gameWidth - objectSize),
    y: -objectSize
  };

  obj.canvas = document.createElement('canvas');
  obj.canvas.width = obj.width;
  obj.canvas.height = obj.height;
  obj.canvas.style.position = 'absolute';
  obj.canvas.style.left = obj.x + 'px';
  obj.canvas.style.top = obj.y + 'px';
  const ctx = obj.canvas.getContext('2d');

  const img = new Image();
  if(type==='gift') img.src = giftImages[Math.floor(Math.random()*giftImages.length)];
  else if(type==='obstacle') img.src = obstacleImages[Math.floor(Math.random()*obstacleImages.length)];
  else if(type==='powerup') img.src = powerupImage;

  img.onload = () => ctx.drawImage(img,0,0,obj.width,obj.height);
  gameArea.appendChild(obj.canvas);
  objects.push(obj);
}

// ----- Move and collision -----
function moveObjects() {
  const { height: gameHeight, width: gameWidth } = getGameDimensions();

  for(let i=objects.length-1;i>=0;i--){
    const obj=objects[i];
    obj.y+=speed;
    obj.canvas.style.top=obj.y+'px';

    const santaRect = { x: santaX, y: gameHeight-santaSize-10, width: santaSize, height: santaSize };
    const objRect = { x: obj.x, y: obj.y, width: obj.width, height: obj.height };

    if(!(santaRect.x+santaRect.width<objRect.x||
         santaRect.x>objRect.x+objRect.width||
         santaRect.y+santaRect.height<objRect.y||
         santaRect.y>objRect.y+objRect.height)){
      if(obj.type==='gift') score+=10;
      else if(obj.type==='powerup') score+=50;
      else if(obj.type==='obstacle') score=Math.max(0,score-10);
      gameArea.removeChild(obj.canvas);
      objects.splice(i,1);
    } else if(obj.y > gameHeight) {
      gameArea.removeChild(obj.canvas);
      objects.splice(i,1);
    }
  }
  document.getElementById('scoreBoard').textContent = "Score: " + score;
}

// ----- Game Loop -----
function gameLoop(){
  if(!gameRunning) return;
  if(Math.random() < 0.015) createObject('gift');      // fewer gifts
if(Math.random() < 0.007) createObject('obstacle');  // fewer obstacles
if(Math.random() < 0.003) createObject('powerup');   // fewer powerups
  moveObjects();
  requestAnimationFrame(gameLoop);
}

// ----- Timer -----
function startTimer(){
  const timerInterval=setInterval(()=>{
    if(!gameRunning) return clearInterval(timerInterval);
    timer--;
    document.getElementById('timer').textContent="Time: "+timer+"s";
    if(timer<=0){ clearInterval(timerInterval); endGame(); }
  },1000);
}

// ----- Controls -----
function updateSantaPosition(x){
  const { width: gameWidth } = getGameDimensions();
  santaX = Math.max(0, Math.min(gameWidth - santaSize, x));
  santaCanvas.style.left = santaX + 'px';
}

gameArea.addEventListener('mousemove',e=>{
  const rect=gameArea.getBoundingClientRect();
  updateSantaPosition(e.clientX - rect.left - santaSize/2);
});
gameArea.addEventListener('touchmove',e=>{
  const rect=gameArea.getBoundingClientRect();
  updateSantaPosition(e.touches[0].clientX - rect.left - santaSize/2);
});

// ----- End Game -----
document.getElementById('stopBtn').addEventListener('click', endGame);
function endGame(){
  if(!gameRunning) return;
  gameRunning=false;
  showScorePopup();
  confetti({particleCount:120,spread:70,origin:{y:0.6}});
}

// ----- Score Popup -----
function showScorePopup(){
  document.getElementById('final-score').textContent = score;
  document.getElementById('score-popup').style.display='flex';
  gameRunning=false;
}

function submitScore(){
  const username=document.getElementById('username-input').value.trim()||'Anonymous';
  const leaderboard=JSON.parse(localStorage.getItem('christmasLeaderboard')||'[]');
  leaderboard.push({username,score});
  leaderboard.sort((a,b)=>b.score-a.score);
  localStorage.setItem('christmasLeaderboard',JSON.stringify(leaderboard.slice(0,10)));
  showPostGameMenu();
}

function skipUsername(){ showPostGameMenu(); }

function showPostGameMenu(){
  document.getElementById('username-input').style.display='none';
  document.querySelectorAll('.username-btn').forEach(btn=>btn.style.display='none');

  // Show leaderboard section
  document.getElementById('leaderboard-section').style.display = 'block';

  updateLeaderboard();
  document.getElementById('post-game-menu').style.display='block';
}

function updateLeaderboard(){
  const leaderboard=JSON.parse(localStorage.getItem('christmasLeaderboard')||'[]');
  const list=document.getElementById('leaderboard');
  list.innerHTML='';
  if(leaderboard.length===0){ const li=document.createElement('li'); li.textContent='No scores yet!'; list.appendChild(li); return; }
  leaderboard.slice(0,10).forEach((item,index)=>{
    const li=document.createElement('li');
    li.textContent=`${index+1}. ${item.username} ‚Äî ${item.score}`;
    list.appendChild(li);
  });
}

// ----- Resize -----
function adjustSizes() {
  setInitialSizes();

  const { width: gameWidth } = getGameDimensions();

  // Update Santa
  santaCanvas.width = santaSize;
  santaCanvas.height = santaSize;
  santaCanvas.style.width = santaSize + 'px';
  santaCanvas.style.height = santaSize + 'px';
  santaX = Math.max(0, Math.min(gameWidth - santaSize, santaX));
  santaCanvas.style.left = santaX + 'px';
  santaCtx.drawImage(santaImg,0,0,santaSize,santaSize);

  // Update objects
  objects.forEach(obj=>{
    obj.width = objectSize;
    obj.height = objectSize;
    obj.canvas.width = objectSize;
    obj.canvas.height = objectSize;
    obj.canvas.style.width = objectSize + 'px';
    obj.canvas.style.height = objectSize + 'px';
    const ctx=obj.canvas.getContext('2d');
    const img = new Image();
    if(obj.type==='gift') img.src = giftImages[Math.floor(Math.random()*giftImages.length)];
    else if(obj.type==='obstacle') img.src = obstacleImages[Math.floor(Math.random()*obstacleImages.length)];
    else if(obj.type==='powerup') img.src = powerupImage;
    img.onload = () => ctx.drawImage(img,0,0,obj.width,obj.height);
  });
}

function goHome() {
  window.location.href = "/";
}

function goGames() {
  window.location.href = "/games";
}

function playAgain() {
  window.location.reload();
}

window.addEventListener('resize', adjustSizes);

// ----- Start Game -----
gameLoop();
startTimer();
</script>

</body>
</html>
